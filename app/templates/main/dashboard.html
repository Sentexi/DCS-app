{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<nav class="breadcrumb">
  <a href="{{ url_for('main.dashboard') }}">Home</a> / Dashboard
</nav>

<div class="page-header">
  <h1 class="page-title">Welcome back, {{ current_user.first_name }}!</h1>
  <div class="row">
    <button class="btn btn-outline">Theme</button>
    <button class="btn btn-secondary">Prefer Judging</button>
  </div>
</div>

<div class="grid">
  <div class="col-8 col-lg-12">
    <div class="card elevated">
      <div class="card-header">
        <span>Current Debate</span>
        {% if current_debate %}
        <span class="badge badge-blue">{{ current_debate.style }}</span>
        {% endif %}
      </div>
      <div class="card-body">
        {% if current_debate %}
        <h3>{{ current_debate.title }}</h3>
        <div class="muted mb-2">{{ user_role or 'Role pending' }}</div>
        <div class="right row mb-3">
          <a href="{{ url_for('debate.judging', debate_id=current_debate.id) }}" class="btn btn-primary">Join Room</a>
          <a href="{{ url_for('main.debate_view', debate_id=current_debate.id) }}" class="btn btn-secondary">View Draw</a>
        </div>
        <div class="progress">
          <div class="progress-bar" style="width: {{ vote_percent or 64 }}%;"></div>
        </div>
        <div class="row mt-2">
          <div class="muted">{{ votes_cast or 0 }}/{{ votes_total or 0 }} votes cast</div>
          {% set room_count = current_debate.speakerslots | map(attribute='room') | unique | list | length %}
          {% set speaker_count = current_debate.speakerslots | rejectattr('role', 'startswith', 'Judge') | list | length %}
          {% set judge_count = current_debate.speakerslots | selectattr('role', 'startswith', 'Judge') | list | length %}
          <div class="right row">
            <span class="badge badge-blue">{{ room_count }} rooms</span>
            <span class="badge badge-blue">{{ speaker_count }} speakers</span>
            <span class="badge badge-blue">{{ judge_count }} judges</span>
          </div>
        </div>
        {% else %}
        <p class="muted">No debate right now.</p>
        {% endif %}
      </div>
      <div class="card-footer">
        <span>#debate #clubnight</span>
        <a href="{{ url_for('profile.view') }}" class="btn btn-outline right">Change Preference</a>
      </div>
    </div>
  </div>
  <div class="col-4 col-lg-12">
    <div class="card">
      <div class="card-header">Your Quick Stats</div>
      <div class="card-body">
        <div class="grid">
          <div class="col-4"><div class="card center"><div class="card-body"><div class="muted">Rank</div><div>{{ current_user.elo_rating }}</div></div></div></div>
          <div class="col-4"><div class="card center"><div class="card-body"><div class="muted">Avg. Speaker</div><div>{{ current_user.opd_skill or 0 }}</div></div></div></div>
          <div class="col-4"><div class="card center"><div class="card-body"><div class="muted">Judged</div><div>{{ current_user.debate_count or 0 }}</div></div></div></div>
        </div>
        <div class="row mt-3">
          <label class="switch">
            <input type="checkbox" id="preferJudging" {% if prefers_judging %}checked{% endif %}>
            <span class="track"><span class="thumb"></span></span>
          </label>
          <span class="muted">Prefer judging tonight</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card mt-4">
  <div class="card-header">
    <div class="tabs">
      <button class="tab active" data-panel="active">Active</button>
      <button class="tab" data-panel="upcoming">Upcoming</button>
      <button class="tab" data-panel="past">Past</button>
    </div>
    <div class="row right">
      <select class="select">
        <option>All Rooms</option>
      </select>
      <button class="btn btn-secondary">Filter</button>
    </div>
  </div>
  <div class="card-body">
    <div class="panel active" data-panel="active">
      <div class="grid">
        {% for d in active_debates %}
        <div class="col-6 col-lg-12">
          <div class="card">
            <div class="card-body">
              <span class="badge badge-blue">{{ d.style }}</span>
              <h3>{{ d.title }}</h3>
              <div class="right row">
                <a href="{{ url_for('main.debate_view', debate_id=d.id) }}" class="btn btn-primary">Open</a>
                <a href="{{ url_for('main.debate_view', debate_id=d.id) }}" class="btn btn-outline">Details</a>
              </div>
            </div>
          </div>
        </div>
        {% else %}
        <p class="muted">No active debates.</p>
        {% endfor %}
      </div>
    </div>
    <div class="panel" data-panel="upcoming">
      {% for d in upcoming_debates %}
      <div class="card">
        <div class="card-body">
          <h3>{{ d.title }}</h3>
          <p class="muted">{{ d.style }}</p>
          <a href="{{ url_for('main.debate_view', debate_id=d.id) }}" class="btn btn-primary">Sign Up</a>
        </div>
      </div>
      {% else %}
      <p class="muted">No upcoming debates.</p>
      {% endfor %}
    </div>
    <div class="panel" data-panel="past">
      <div class="card">
        <div class="card-body">
          <h3>Recent Results</h3>
          <div class="rooms">
            <div class="room">
              <div class="role gov"><span>Gov</span><span class="tag">Win</span></div>
              <div class="role opp"><span>Opp</span><span class="tag">Loss</span></div>
            </div>
            <div class="room">
              <div class="role gov"><span>Gov</span><span class="tag">Loss</span></div>
              <div class="role opp"><span>Opp</span><span class="tag">Win</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="page-header mt-5">
  <h2 class="page-title">User Management</h2>
  <div class="row">
    <input class="input" type="text" placeholder="Search">
    <button class="btn btn-secondary">Export CSV</button>
    <button class="btn btn-primary">Add User</button>
  </div>
</div>
<div class="table-wrap">
  <table>
    <thead>
      <tr><th>Name</th><th>Email</th><th class="right">Actions</th></tr>
    </thead>
    <tbody>
      <tr><td>Jane Doe</td><td>jane@example.com</td><td class="actions"><button class="btn btn-secondary btn-sm">Edit</button> <button class="btn btn-warning btn-sm">Make Admin</button></td></tr>
      <tr><td>John Smith</td><td>john@example.com</td><td class="actions"><button class="btn btn-secondary btn-sm">Edit</button> <button class="btn btn-warning btn-sm">Make Admin</button></td></tr>
    </tbody>
  </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const panel = tab.dataset.panel;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.panel').forEach(p => {
      p.classList.toggle('active', p.dataset.panel === panel);
      p.style.display = p.dataset.panel === panel ? 'block' : 'none';
    });
  });
});
</script>
{% endblock %}
