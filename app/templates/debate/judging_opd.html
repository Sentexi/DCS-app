{% extends "base.html" %}
{% block title %}Judging - {{ debate.title }}{% endblock %}
{% block content %}
<h2 class="mb-4">{{ debate.title }} â€“ Scoring</h2>
<form method="post">
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Speaker</th>
        {% for j in judges %}
          <th>{{ j.user.first_name }} {{ j.user.last_name }}</th>
        {% endfor %}
        <th>Average</th>
      </tr>
    </thead>
    <tbody>
      {% for sp in speakers %}
      <tr data-role="{{ sp.role }}" data-sid="{{ sp.id }}">
        <td>{{ sp.user.first_name }} {{ sp.user.last_name }} <small class="text-muted">({{ sp.role }})</small></td>
        {% for j in judges %}
          <td><input type="number" min="0" max="100" step="1" name="score_{{ sp.id }}_{{ j.id }}" class="form-control score-input" value="{{ scores.get((sp.user_id, j.user_id), '') }}"></td>
        {% endfor %}
        <td class="avg">0</td>
      </tr>
      {% endfor %}
{% with first_judge=judges.0 %}
  {% for j in judges %}
    {% if j.id != first_judge.id %}
      <tr>
        <td>Evaluation of {{ j.user.first_name }} {{ j.user.last_name }}</td>

        {# iterate over all judge columns; put radios only in first judge's column #}
        {% for col in judges %}
          {% if col.id == first_judge.id %}
            <td>
	    <label>
	    <input type="radio" name="feedback_{{ j.user_id }}" value="positive"
	    {% if feedback.get(j.user.id) == 'positive' %}checked{% endif %} required> Positive
	    </label>
	    <label>
	    <input type="radio" name="feedback_{{ j.user_id }}" value="neutral"
	    {% if feedback.get(j.user.id) == 'neutral' %}checked{% endif %}> Neutral
	    </label>
	    <label>
	    <input type="radio" name="feedback_{{ j.user_id }}" value="negative"
	    {% if feedback.get(j.user.id) == 'negative' %}checked{% endif %}> Negative
	    </label>
	    </td>
          {% else %}
            <td></td>
          {% endif %}
        {% endfor %}

        <td></td> {# Average column (empty) #}
      </tr>
    {% endif %}
  {% endfor %}
{% endwith %}
    </tbody>
  </table>
  <p><strong>Government:</strong> <span id="gov-total">0</span></p>
  <p><strong>Opposition:</strong> <span id="opp-total">0</span></p>
  <p>Note on wing judge evaluation: Wing judges never see this evaluation, the purpose is updating the experience level of wing judges according to their performance. Neutral never changes their status and should be the default selection, positive can promote them up to wing status. Multiple negative evaluations reduce their probability of being selected as judge.</p>
  <p>It is normal that the selection is invisible after saving, the system has still received the information.</p>
  <button type="submit" class="btn btn-primary">Save</button>
</form>
<form method="post" action="{{ url_for('debate.finalize', debate_id=debate.id) }}" onsubmit="return confirm('Finalize this debate?');">
  <button type="submit" class="btn btn-danger mt-3">Finalize Debate</button>
</form>
{% endblock %}
{% block extra_js %}
<script>
function update() {
  let gov=0, opp=0;
  document.querySelectorAll('tbody tr').forEach(row=>{
    let sum=0,count=0;
    row.querySelectorAll('.score-input').forEach(inp=>{
      const v=parseFloat(inp.value); if(!isNaN(v)){sum+=v;count++;}
    });
    const avg = count?sum/count:0;
    row.querySelector('.avg').textContent=avg.toFixed(1);
    if(row.dataset.role.startsWith('Gov')) gov+=avg;
    else if(row.dataset.role.startsWith('Opp')) opp+=avg;
  });
  document.getElementById('gov-total').textContent=gov.toFixed(1);
  document.getElementById('opp-total').textContent=opp.toFixed(1);
}
update();
document.querySelectorAll('.score-input').forEach(inp=>inp.addEventListener('input', update));
</script>
<script>
const socket = io();
const currentDebateId = {{ debate.id }};
socket.on('assignments_ready', data => {
  if (data.debate_id === currentDebateId) {
    window.location.reload();
  }
});
</script>
{% endblock %}
